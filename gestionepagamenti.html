<html>
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<title>Pagamenti Marco Express Ac</title>
</head>
<body>

  <p class='ltext' id='intro'>Gestisci qui i tuoi pagamenti Marco Express. <br>Per maggiore sicurezza, accedi nuovamente.</p>
  <input type="text" placeholder="Email" id="email"></input><br><br>
  <input type="password" placeholder="Password" id="password"/>
  <button id="button" type="button" onclick="showPwd()">
  <img src='https://lh3.googleusercontent.com/pw/ACtC-3fsiPnrtt4QsQITPf6bt7DuGpEJAp2jiVi9HDAMd9lfL2n_zRkioGhq3ON7kNKTkDYH0U-Cg1He3jzivqsRC87hgNx3bZoE9QOE4cnWiTqKElk_I5CvicwuHro24wXBohZhEmOWC5OTgUBiULJGhc55=s24-no?authuser=0' height='40px'></img>
</button><br><br>
<button onclick="signIn()" id="signIn"><h1><b>Login</b></h1></button><br><br>
<span id='display'></span>
<h1 id='reip'>Hai dimenticato la password? Reimpostala sul sito Meteo Marco o sul sito "Il mio Account Marco Express"</h1></center>

  <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyCIw0-w1C3zDjoGgVpLKsFYm2TFXqJr9yw",
  authDomain: "marco-express-d30c8.firebaseapp.com",
  projectId: "marco-express-d30c8",
  storageBucket: "marco-express-d30c8.appspot.com",
  messagingSenderId: "764621319758",
  appId: "1:764621319758:web:9390a4a994df27cda4dd1f",
  measurementId: "G-3ZK6NW0G3F"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();

function signIn(){
  if(navigator.onLine){
  var email = document.getElementById("email");
  var password = document.getElementById("password");
  const promise = auth.signInWithEmailAndPassword(email.value, password.value);
  promise.catch(e => alert('Combinazione utente/password errata'));

}else{
  document.getElementById('display').innerHTML = '<h1>Impossibile connetersi al server</h1>'
}}

auth.onAuthStateChanged(function(user){
   document.title = "Pagamenti Marco Express AC";
    var email = user.email;
    console.warn('Utente attivo.')

    document.getElementById("password").style.display="none";
    document.getElementById("email").style.display="none";
    document.getElementById("signIn").style.display="none";
    document.getElementById("button").style.display="none";
    document.getElementById("intro").style.display="none";
    document.getElementById("reip").style.display="none";

    var disp = document.getElementById('display')
    disp.innerHTML = "<p class='ltext'>Gestisci i tuoi pagamenti</p>"

    var user = firebase.auth().currentUser;
    user.providerData.forEach(function (profile) {
      disp.innerHTML += "<p class='ntext'>Denaro totale prepagato memorizzato nell'account: " + "</p><p class='ltext'>&euro;"+ profile.displayName + "</p>"
    });

    disp.innerHTML += "<button id='nuovop' onclick='prepagato()'><h1>Aggiungi denaro</h1></button><br><br>"
    disp.innerHTML += "<button onclick='nspesa()' id='nuovos'><h1>Nuova spesa</h1></button>"
   });


   function prepagato() {
var disp = document.getElementById('display')
     disp.innerHTML = "<p class='ltext'>Passaggi per la ricarica del portafoglio:</p>"
     disp.innerHTML += "<p class='ntext'>1) Imposta il numero di soldi</p>"
     disp.innerHTML += "<input type='number' id='euroc' style='width: 10%'></input><h1>&nbsp;&nbsp;&nbsp;&euro;</h1>"
     disp.innerHTML += "<p class='ntext'>2) Recati alla sede centrale Marco Express</p>"
     disp.innerHTML += "<p class='ntext'>3) Chiedi la ricarica del portafoglio, mostrandogli il seguente QR code</p><center><button onclick='creaq()' id='creaq' style='width:20%'><h1>Crea il QRcode</h1></button></center><canvas id='q'></canvas><br><br><br><br><br><br><button onclick='ritornadap()' id='ann'><h1>Esci</h1></button>"
    //



   }

   function creaq(){
     document.getElementById("creaq").style.display="none";
     var user = firebase.auth().currentUser;
     user.providerData.forEach(function (profile) {
      var email = profile.email
      var num = document.getElementById('euroc').value
      var testq = "Richiesta da parte di " + email + ". &euro;" + num + ". https://marco-express.github.io/marcoexpress.official.site.github.io/arearis.html"

      new QRious({element: document.getElementById("q"), value: testq, size: 300});

     });


   }

   function nspesa(){
     var disp = document.getElementById('display')
    disp.innerHTML = "<center><p class='ltext'>Nuova spesa</p></center>"
    disp.innerHTML += '<select name="nuovaspesa" id="nn" style="width: 90%"><option value="mmppu"><h1>Abbonamento Meteo Marco Premium Plus - 1 Settimana</h1></option><option value="mmppd"><h1>Abbonamento Meteo Marco Premium Plus - 2 Settimane</h1></option></select><span id="costo"></span><span id="push"></span>'
    setTimeout('ripeti()', 100)
   }

   function ripeti() {
     var disp = document.getElementById('display')
      var tipo = document.getElementById("nn").value
      console.log(tipo)
      if(tipo==="mmppu"){
        mmppu();
      }else if(tipo==="mmppd"){
        mmppd()
      }
      setTimeout('ripeti()', 500)
   }

function mmppu() {
  var user = firebase.auth().currentUser;
  user.providerData.forEach(function (profile) {
    if(profile.photoURL != ' ') {
      document.getElementById('costo').innerHTML = "<p class='ntext' style='background: red'>Hai gi&agrave; un abbonamento Meteo Marco Premium Plus Attivo.</p>"
    }else{
        document.getElementById('costo').innerHTML = "<p class='ntext'>Costo: &euro; 0,75</p>"
        document.getElementById('push').innerHTML = "<button onclick='comprammpp()' class='comprap'><h1>Acquista ora!</h1></button>"

    }

 });
}

function mmppd(){
  var user = firebase.auth().currentUser;
  user.providerData.forEach(function (profile) {
    if(profile.photoURL != ' ') {
      document.getElementById('costo').innerHTML = "<p class='ntext' style='background: red'>Hai gi&agrave; un abbonamento Meteo Marco Premium Plus Attivo.</p>"
    }else{
        document.getElementById('costo').innerHTML = "<p class='ntext'>Costo: &euro; 1,50</p>"
        document.getElementById('push').innerHTML = "<button onclick='comprammppd()' class='comprap'><h1>Acquista ora!</h1></button>"

    }

 });
}

function comprammpp() {
  var disp = document.getElementById('display')
  disp.innerHTML = "<p class='ltext'>Vuoi effettuare l'acquisto?</p><p class='ntext'>Importo: &euro; 0,75<br>Nome articolo: Meteo Marco Premium Plus<br>Durata: 1 Settimana</p>"
  disp.innerHTML += "<button id='ann' onclick='ritornadap()'><h1>Annulla</h1></button><button id='acq' onclick='acquistammpp()'><h1>Acquista</h1></button>"

}

function comprammppd() {
  var disp = document.getElementById('display')
  disp.innerHTML = "<p class='ltext'>Vuoi effettuare l'acquisto?</p><p class='ntext'>Importo: &euro; 1,50<br>Nome articolo: Meteo Marco Premium Plus<br>Durata: 2 Settimane</p>"
  disp.innerHTML += "<button id='ann' onclick='ritornadap()'><h1>Annulla</h1></button><button id='acq' onclick='acquistammppd()'><h1>Acquista</h1></button>"

}

function acquistammpp(){
  var user = firebase.auth().currentUser;
  user.providerData.forEach(function (profile) {
    if(profile.displayName < 0.75){
      console.log('non hai soldi, POVERO!')
      document.getElementById('display').innerHTML = "<p class='ltext'>Denaro insufficente</p><p class='ntext'>Sembra che nel tuo account non ci siano i soldi necessari per l'acquisto. Se vuoi ricaricare il portafoglio <a onclick='prepagato()'>CLICCA QUI</a>. "
    }else{
      var soldiad = profile.displayName
      var numsoldiad = Number(soldiad);
      var fine = numsoldiad - 0.75
      var invia = "" + fine
      console.log(typeof invia)
      user.updateProfile({
     displayName: invia
   }).then(function() {
     console.log('primo ok')
   }).catch(function(error) {
     document.write("<p class='ltext'>Errore</p><br><h1>Si &egrave; verificato un errore imprevisto. Tipo di errore: errore nel pagamento</h1>")
   });

                var d = new Date();
                orad = d.getHours();
                min = d.getMinutes();
                dataduen = d.getDate();
                mesed = d.getMonth();
                annodue = d.getFullYear();
                mesed++

                var piusett = new Date()
                piusett.setDate(dataduen + 7)
                console.log(piusett)
                var invia = ""+piusett
   user.updateProfile({
  photoURL: invia
}).then(function() {
  alert('Acquisto effettuato, ora puoi accedere ai servizi offerti da Meteo Marco Premium Plus')
  ritornadap()
}).catch(function(error) {
    document.write("Errore, contatta un tecnico Marco Express. <br>Dettagli: <br> Pagamento riuscito: true <br> Memorizzazione dati nell'account: false<br>Error type: " + error)
});


    }
  });
}



function acquistammppd(){
  var user = firebase.auth().currentUser;
  user.providerData.forEach(function (profile) {
    if(profile.displayName < 1.5){
      console.log('non hai soldi, POVERO!')
      document.getElementById('display').innerHTML = "<p class='ltext'>Denaro insufficente</p><p class='ntext'>Sembra che nel tuo account non ci siano i soldi necessari per l'acquisto. Se vuoi ricaricare il portafoglio <a onclick='prepagato()'>CLICCA QUI</a>. "
    }else{
      var soldiad = profile.displayName
      var numsoldiad = Number(soldiad);
      var fine = numsoldiad - 1.5
      var invia = "" + fine
      console.log(typeof invia)
      user.updateProfile({
     displayName: invia
   }).then(function() {
     console.log('primo ok')
   }).catch(function(error) {
     document.write("<p class='ltext'>Errore</p><br><h1>Si &egrave; verificato un errore imprevisto. Tipo di errore: errore nel pagamento</h1>")
   });

                var d = new Date();
                orad = d.getHours();
                min = d.getMinutes();
                dataduen = d.getDate();
                mesed = d.getMonth();
                annodue = d.getFullYear();
                mesed++

                var piusett = new Date()
                piusett.setDate(dataduen + 14)
                console.log(piusett)
                var invia = ""+piusett
   user.updateProfile({
  photoURL: invia
}).then(function() {
  alert('Acquisto effettuato, ora puoi accedere ai servizi offerti da Meteo Marco Premium Plus')
  ritornadap()
}).catch(function(error) {
    document.write("Errore, contatta un tecnico Marco Express. <br>Dettagli: <br> Pagamento riuscito: true <br> Memorizzazione dati nell'account: false<br>Error type: " + error)
});


    }
  });
}

function esci() {
  document.getElementById('display').innerHTML = "<button onclick='ritornadap()' id='acq'>Esci</button>"
}

function ritornadap(){
  var disp = document.getElementById('display')
  disp.innerHTML = "<p class='ltext'>Gestisci i tuoi pagamenti</p>"

  var user = firebase.auth().currentUser;
  user.providerData.forEach(function (profile) {
    disp.innerHTML += "<p class='ntext'>Denaro totale prepagato memorizzato nell'account: " + "</p><p class='ltext'>&euro;"+ profile.displayName + "</p>"
  });

  disp.innerHTML += "<button id='nuovop' onclick='prepagato()'><h1>Aggiungi denaro</h1></button><br><br>"
  disp.innerHTML += "<button onclick='nspesa()' id='nuovos'><h1>Nuova spesa</h1></button>"
 }

function showPwd() {
  var input = document.getElementById('password');
  if (input.type === "password") {
    input.type = "text";
  } else {
    input.type = "password";

  }
}

function alt(){
  var user = firebase.auth().currentUser;
  user.providerData.forEach(function (profile) {
    console.log(profile.displayName)
  })
}


</script>


<style>
button{
  cursor: pointer;
}
#signOut {
  height: 25%;
  background: #f0cccc;
  width: 38%;
  border: 3px solid red;
  letter-spacing: 2px;
  border-radius: 15px;
  box-shadow: 10px 10px 5px #dedede;
}
#signIn {
  background: #b2f7bc;
  width: 200px;
  border: 3px solid #0af52c;
  letter-spacing: 2px;
  border-radius: 40px;
}
#ann {
  background: #ff4040;
  width: 200px;
  border: 3px solid #db0700;
  letter-spacing: 2px;
  border-radius: 40px;
  float:left;
}
#acq {
  background: #b2f7bc;
  width: 200px;
  border: 3px solid #0af52c;
  letter-spacing: 2px;
  border-radius: 40px;
  float: right;
}
#password,#email {
  width:80%;
  background: #d5dbd6;
  border: 3px solid black;
  font-size: 250%;
  border-radius: 20px;
  box-shadow: 15px 10px 5px #dedede;

}
#euroc{
  font-size: 25px;
  border: 2px solid black;
  float: left;
}
.ltext{
  font-family: 'Lato', sans-serif;
  font-size: 50px
}
.ntext{
  font-family: 'Lato', sans-serif;
  font-size: 35px
}
#nn{
  font-size: 30px;
  border-radius: 5px;
  background-color: #cfd3d4;
}
.comprap{
  border: 3px solid #0af52c;
  background: #b2f7bc;
  width: 20%;
  height: 75px;
  border-radius: 20px;
}

#nuovop{
  width: 60%;
  background-color: #4de34b;
  background-image: url("uno.png");
  background-repeat: no-repeat;
  background-position: left;
  background-size: contain;
  border-radius: 20px;
  border: 3px solid #03ff00;
}

#nuovos{
  width: 60%;
  background-color: #eb5b5b;
  background-image: url("spesa.png");
  background-repeat: no-repeat;
  background-position: left;
  background-size: contain;
  border-radius: 20px;
  border: 3px solid #d10000;
}
</style>

</body>
</html>
